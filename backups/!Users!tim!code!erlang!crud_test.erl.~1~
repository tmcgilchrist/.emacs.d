start() ->
    mochiweb_http:start(
      [{ip, "127.0.0.1"},
       {loop, {?MODULE, crud_response}}]).
stop() ->
    mochiweb_http:stop().


crud_response(Req, 'GET', "/person/" ++ IdString) ->
    Id = list_to_integer(IdString),
    Response = crud:retrieve(Id),
    Req:ok({"text/plain", ttp(Response)});

crud_response(Req, 'DELETE', "/person/" ++ IdString) ->
    Id = list_to_integer(IdString),
    Response = crud:delete(Id),
    Req:ok({"text/plain", ttp(Response)});

crud_response(Req, 'POST', "/person") ->
    Body = Req:recv_body(),
    Person = ptt(Body),
    Response = crud:create(Person),
    Req:ok({"text/plain", ttp(Response)});

crud_response(Req, 'PUT', "/person/" ++ IdString) ->
    Id = list_to_integer(IdString),
    Body = Req:recv_body(),
    PersonWithNewValues = ptt(Body),
    UpdatedPerson = #person{id = Id, 
                            name = PersonWithNewValues#person.name, 
                            email_address = PersonWithNewValues#person.email_address},
    Response = crud:update(UpdatedPerson),
    Req:ok({"text/plain", ttp(Response)});
        
crud_response(Req, _Method, Path) ->
    Req:respond({501, [], Path}).

crud_response(Req) ->
    crud_response(Req, Req:get(method), Req:get(path)).
    
